<!--packageCommunity/pages/search/search.wxml-->
<view class="container">
  <!-- 搜索栏 -->
  <view class="search-bar">
    <view class="search-input-container">
      <text class="iconfont icon-search"></text>
      <input class="search-input" 
             placeholder="搜索习惯、话题、用户" 
             value="{{keyword}}" 
             bindinput="inputKeyword"
             bindconfirm="doSearch"
             focus="true"
             confirm-type="search" />
      <text class="iconfont icon-close" bindtap="clearKeyword" wx:if="{{keyword}}"></text>
    </view>
    <view class="cancel-btn" bindtap="navigateBack">取消</view>
  </view>
  
  <!-- 搜索内容区域 -->
  <view class="search-content">
    <!-- 搜索历史和热门搜索 -->
    <view class="search-initial" wx:if="{{!keyword || !hasSearched}}">
      <!-- 搜索历史 -->
      <view class="search-history" wx:if="{{searchHistory.length > 0}}">
        <view class="section-header">
          <text class="section-title">搜索历史</text>
          <text class="clear-btn" bindtap="clearHistory">清空</text>
        </view>
        <view class="history-list">
          <view class="history-item" 
                wx:for="{{searchHistory}}" 
                wx:key="*this"
                bindtap="useHistoryKeyword"
                data-keyword="{{item}}">
            <text class="iconfont icon-time"></text>
            <text class="history-text">{{item}}</text>
          </view>
        </view>
      </view>
      
      <!-- 热门搜索 -->
      <view class="hot-search">
        <view class="section-header">
          <text class="section-title">热门搜索</text>
        </view>
        <view class="hot-tags">
          <view class="hot-tag" 
                wx:for="{{hotSearches}}" 
                wx:key="*this"
                bindtap="useHotKeyword"
                data-keyword="{{item}}">
            {{item}}
          </view>
        </view>
      </view>
    </view>
    
    <!-- 搜索结果 -->
    <view class="search-results" wx:if="{{keyword && hasSearched}}">
      <!-- 标签页导航 -->
      <view class="tabs">
        <view class="tab-item {{activeTab === 'all' ? 'active' : ''}}" bindtap="switchTab" data-tab="all">全部</view>
        <view class="tab-item {{activeTab === 'posts' ? 'active' : ''}}" bindtap="switchTab" data-tab="posts">动态</view>
        <view class="tab-item {{activeTab === 'users' ? 'active' : ''}}" bindtap="switchTab" data-tab="users">用户</view>
        <view class="tab-item {{activeTab === 'habits' ? 'active' : ''}}" bindtap="switchTab" data-tab="habits">习惯</view>
        <view class="tab-item {{activeTab === 'topics' ? 'active' : ''}}" bindtap="switchTab" data-tab="topics">话题</view>
      </view>
      
      <!-- 加载状态 -->
      <view class="loading" wx:if="{{loading}}">
        <view class="loading-spinner"></view>
        <text class="loading-text">搜索中...</text>
      </view>
      
      <!-- 搜索结果列表 -->
      <view class="result-list" wx:if="{{!loading && results.length > 0}}">
        <!-- 动态结果 -->
        <view class="post-item" 
              wx:for="{{activeTab === 'all' || activeTab === 'posts' ? results : []}}" 
              wx:key="id"
              wx:if="{{item.type === 'post'}}"
              bindtap="viewPostDetail"
              data-id="{{item.id}}">
          <view class="post-header">
            <image class="user-avatar" src="{{item.userAvatar}}" mode="aspectFill" catchtap="viewUserProfile" data-id="{{item.userId}}"></image>
            <view class="post-user-info">
              <text class="username">{{item.userName}}</text>
              <text class="post-time">{{item.time}}</text>
            </view>
          </view>
          <view class="post-content">
            <text class="post-text">{{item.content}}</text>
          </view>
          <view class="post-stats">
            <text class="post-stat">{{item.likes}}赞</text>
            <text class="post-stat">{{item.comments}}评论</text>
          </view>
        </view>
        
        <!-- 用户结果 -->
        <view class="user-item" 
              wx:for="{{activeTab === 'all' || activeTab === 'users' ? results : []}}" 
              wx:key="id"
              wx:if="{{item.type === 'user'}}"
              bindtap="viewUserProfile"
              data-id="{{item.id}}">
          <image class="user-avatar" src="{{item.avatar}}" mode="aspectFill"></image>
          <view class="user-info">
            <text class="username">{{item.name}}</text>
            <text class="user-bio">{{item.bio}}</text>
          </view>
          <button class="follow-btn {{item.isFollowing ? 'following' : ''}}" 
                  catchtap="toggleFollow" 
                  data-id="{{item.id}}"
                  data-index="{{index}}">
            {{item.isFollowing ? '已关注' : '关注'}}
          </button>
        </view>
        
        <!-- 习惯结果 -->
        <view class="habit-item" 
              wx:for="{{activeTab === 'all' || activeTab === 'habits' ? results : []}}" 
              wx:key="id"
              wx:if="{{item.type === 'habit'}}"
              bindtap="viewHabitDetail"
              data-id="{{item.id}}">
          <view class="habit-icon" style="background-color: {{item.color}}">
            <image src="{{item.icon}}" mode="aspectFit"></image>
          </view>
          <view class="habit-info">
            <text class="habit-name">{{item.name}}</text>
            <text class="habit-users">{{item.users}}人在坚持</text>
          </view>
          <button class="add-btn {{item.isAdded ? 'added' : ''}}" 
                  catchtap="toggleAddHabit" 
                  data-id="{{item.id}}"
                  data-index="{{index}}">
            {{item.isAdded ? '已添加' : '添加'}}
          </button>
        </view>
        
        <!-- 话题结果 -->
        <view class="topic-item" 
              wx:for="{{activeTab === 'all' || activeTab === 'topics' ? results : []}}" 
              wx:key="id"
              wx:if="{{item.type === 'topic'}}"
              bindtap="viewTopicDetail"
              data-id="{{item.id}}">
          <image class="topic-image" src="{{item.image}}" mode="aspectFill"></image>
          <view class="topic-info">
            <text class="topic-name">#{{item.name}}</text>
            <text class="topic-posts">{{item.posts}}条动态</text>
          </view>
        </view>
      </view>
      
      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{!loading && results.length === 0}}">
        <image class="empty-icon" src="/images/icons/empty-search.png" mode="aspectFit"></image>
        <text class="empty-text">没有找到相关内容</text>
        <text class="empty-tips">换个关键词试试吧</text>
      </view>
      
      <!-- 加载更多 -->
      <view class="loading-more" wx:if="{{loadingMore}}">
        <view class="loading-spinner small"></view>
        <text class="loading-text">加载更多...</text>
      </view>
      
      <!-- 没有更多数据 -->
      <view class="no-more" wx:if="{{!loading && !loadingMore && !hasMore && results.length > 0}}">
        <text>没有更多结果了</text>
      </view>
    </view>
  </view>
</view> 
