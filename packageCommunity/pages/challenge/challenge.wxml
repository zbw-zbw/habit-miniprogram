<!--packageCommunity/pages/challenge/challenge.wxml-->
<view class="challenge-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-icon"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content" wx:if="{{!loading}}">
    <!-- æŒ‘æˆ˜å¤´éƒ¨ -->
    <view class="challenge-header">
      <image class="challenge-image" src="{{challenge.image}}" mode="aspectFill"></image>
      <view class="challenge-info">
        <text class="challenge-title">{{challenge.title}}</text>
        <view class="challenge-meta">
          <text class="challenge-date">{{challenge.startDate}} è‡³ {{challenge.endDate}}</text>
          <text class="challenge-participants">{{challenge.participants}}äººå‚ä¸</text>
        </view>
        <view class="challenge-buttons">
          <button class="btn-join" wx:if="{{!challenge.isJoined}}" bindtap="showJoinModal">å‚åŠ æŒ‘æˆ˜</button>
          <button class="btn-joined" wx:else>å·²å‚åŠ </button>
          <button class="btn-share" open-type="share">é‚€è¯·å¥½å‹</button>
        </view>
      </view>
    </view>

    <!-- æ ‡ç­¾æ  -->
    <view class="tab-bar">
      <view class="tab-item {{tabActive === 'intro' ? 'active' : ''}}" bindtap="switchTab" data-tab="intro">
        <text>æŒ‘æˆ˜ä»‹ç»</text>
      </view>
      <view class="tab-item {{tabActive === 'rank' ? 'active' : ''}}" bindtap="switchTab" data-tab="rank">
        <text>æ’è¡Œæ¦œ</text>
      </view>
      <view class="tab-item {{tabActive === 'posts' ? 'active' : ''}}" bindtap="switchTab" data-tab="posts">
        <text>åŠ¨æ€</text>
      </view>
    </view>

    <!-- æŒ‘æˆ˜ä»‹ç» -->
    <view class="tab-content" wx:if="{{tabActive === 'intro'}}">
      <view class="intro-section">
        <view class="section-title">æŒ‘æˆ˜è¯´æ˜</view>
        <view class="section-content">
          <text class="challenge-description">{{challenge.description}}</text>
        </view>
      </view>

      <view class="intro-section">
        <view class="section-title">æŒ‘æˆ˜è§„åˆ™</view>
        <view class="section-content">
          <view class="rule-item" wx:for="{{challenge.rules}}" wx:key="*this">
            <text class="rule-num">{{index + 1}}.</text>
            <text class="rule-text">{{item}}</text>
          </view>
        </view>
      </view>

      <view class="intro-section">
        <view class="section-title">æŒ‘æˆ˜å¥–åŠ±</view>
        <view class="section-content">
          <view class="reward-item" wx:for="{{challenge.rewards}}" wx:key="*this">
            <text class="reward-icon">ğŸ†</text>
            <text class="reward-text">{{item}}</text>
          </view>
        </view>
      </view>

      <view class="intro-section">
        <view class="section-title">å‘èµ·äºº</view>
        <view class="section-content">
          <view class="creator-info" bindtap="viewUserProfile" data-user-id="{{challenge.creator.id}}">
            <image class="creator-avatar" src="{{challenge.creator.avatar}}"></image>
            <text class="creator-name">{{challenge.creator.name}}</text>
            <view class="creator-arrow"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ’è¡Œæ¦œ -->
    <view class="tab-content" wx:if="{{tabActive === 'rank'}}">
      <view class="rank-list">
        <view class="rank-header">
          <text class="rank-header-rank">æ’å</text>
          <text class="rank-header-user">ç”¨æˆ·</text>
          <text class="rank-header-progress">è¿›åº¦</text>
        </view>
        <view class="rank-item" wx:for="{{participants}}" wx:key="id" bindtap="viewUserProfile" data-user-id="{{item.id}}">
          <view class="rank-position {{item.rank <= 3 ? 'top' + item.rank : ''}}">{{item.rank}}</view>
          <view class="rank-user">
            <image class="rank-avatar" src="{{item.avatar}}"></image>
            <text class="rank-name">{{item.name}}</text>
          </view>
          <view class="rank-progress">
            <progress class="progress-bar" percent="{{item.progress}}" stroke-width="4" color="#4F7CFF" />
            <text class="progress-text">{{item.progress}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ¨æ€ -->
    <view class="tab-content" wx:if="{{tabActive === 'posts'}}">
      <view class="post-list">
        <view class="post-item" wx:for="{{posts}}" wx:key="id">
          <view class="post-header" bindtap="viewUserProfile" data-user-id="{{item.userId}}">
            <image class="post-avatar" src="{{item.userAvatar}}"></image>
            <view class="post-user-info">
              <text class="post-username">{{item.userName}}</text>
              <text class="post-time">{{item.createdAt}}</text>
            </view>
          </view>
          <view class="post-content">
            <text class="post-text">{{item.content}}</text>
            <view class="post-images" wx:if="{{item.images.length > 0}}">
              <image 
                class="post-image {{item.images.length === 1 ? 'single' : ''}}" 
                wx:for="{{item.images}}" 
                wx:for-item="image" 
                wx:key="*this" 
                src="{{image}}" 
                mode="aspectFill"
              ></image>
            </view>
          </view>
          <view class="post-actions">
            <view class="post-action" bindtap="likePost" data-index="{{index}}">
              <view class="action-icon {{item.isLiked ? 'liked' : ''}}">â¤</view>
              <text class="action-count">{{item.likes}}</text>
            </view>
            <view class="post-action" bindtap="commentPost" data-post-id="{{item.id}}">
              <view class="action-icon">ğŸ’¬</view>
              <text class="action-count">{{item.comments}}</text>
            </view>
            <view class="post-action" bindtap="sharePost" data-post-id="{{item.id}}">
              <view class="action-icon">â†—</view>
              <text class="action-count">åˆ†äº«</text>
            </view>
          </view>
        </view>
        
        <view class="empty-posts" wx:if="{{posts.length === 0}}">
          <text>æš‚æ— åŠ¨æ€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</text>
        </view>
      </view>
      
      <view class="post-create-btn" wx:if="{{challenge.isJoined}}" bindtap="createPost">
        <text>å‘å¸ƒåŠ¨æ€</text>
      </view>
    </view>
  </view>

  <!-- åŠ å…¥æŒ‘æˆ˜æ¨¡æ€æ¡† -->
  <view class="modal join-modal {{showJoinModal ? 'show' : ''}}" catchtouchmove="true">
    <view class="modal-mask" bindtap="hideJoinModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">åŠ å…¥æŒ‘æˆ˜</text>
        <view class="modal-close" bindtap="hideJoinModal">Ã—</view>
      </view>
      <view class="modal-body">
        <text class="join-tips">ç¡®å®šè¦å‚åŠ "{{challenge.title}}"æŒ‘æˆ˜å—ï¼Ÿ</text>
        <text class="join-desc">å‚åŠ åéœ€éµå®ˆæŒ‘æˆ˜è§„åˆ™ï¼ŒæŒ‰æ—¶å®Œæˆæ‰“å¡ä»»åŠ¡ã€‚</text>
      </view>
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideJoinModal">å–æ¶ˆ</button>
        <button class="btn-confirm" bindtap="joinChallenge">ç¡®å®šå‚åŠ </button>
      </view>
    </view>
  </view>

  <!-- åˆ†äº«æ¨¡æ€æ¡† -->
  <view class="modal share-modal {{showShareModal ? 'show' : ''}}" catchtouchmove="true">
    <view class="modal-mask" bindtap="hideShareModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">åˆ†äº«åˆ°</text>
        <view class="modal-close" bindtap="hideShareModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="share-options">
          <button class="share-option" open-type="share">
            <view class="share-icon wechat">å¾®ä¿¡</view>
            <text class="share-text">å¾®ä¿¡</text>
          </button>
          <view class="share-option">
            <view class="share-icon moments">æœ‹å‹åœˆ</view>
            <text class="share-text">æœ‹å‹åœˆ</text>
          </view>
          <view class="share-option">
            <view class="share-icon qq">QQ</view>
            <text class="share-text">QQ</text>
          </view>
          <view class="share-option">
            <view class="share-icon weibo">å¾®åš</view>
            <text class="share-text">å¾®åš</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
