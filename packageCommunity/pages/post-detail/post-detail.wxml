<!--packageCommunity/pages/post-detail/post-detail.wxml-->
<view class="container">
  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
  
  <!-- 动态详情 -->
  <view class="post-detail" wx:if="{{!loading && post}}">
    <!-- 动态头部 -->
    <view class="post-header">
      <image class="user-avatar" src="{{post.userAvatar}}" mode="aspectFill" bindtap="viewUserProfile"></image>
      <view class="post-user-info">
        <text class="username" bindtap="viewUserProfile">{{post.userName}}</text>
        <text class="post-time">{{post.createdAt}}</text>
      </view>
      <view class="post-more" bindtap="showActionSheet">
        <text class="iconfont icon-more"></text>
      </view>
    </view>
    
    <!-- 动态内容 -->
    <view class="post-content">
      <text class="post-text">{{post.content}}</text>
      
      <!-- 标签 -->
      <view class="post-tags" wx:if="{{post.tags && post.tags.length > 0}}">
        <view class="post-tag" wx:for="{{post.tags}}" wx:key="*this" wx:for-item="tag" bindtap="searchTag" data-tag="{{tag}}">
          <text class="iconfont icon-tag"></text>
          <text>{{tag}}</text>
        </view>
      </view>
      
      <!-- 图片 -->
      <view class="post-images" wx:if="{{post.images && post.images.length > 0}}">
        <block wx:if="{{post.images.length === 1}}">
          <image class="post-image single" src="{{post.images[0]}}" mode="widthFix" bindtap="previewImage" data-index="0"></image>
        </block>
        <block wx:elif="{{post.images.length > 1}}">
          <view class="image-grid">
            <image class="post-image multiple" 
                   wx:for="{{post.images}}" 
                   wx:for-item="img"
                   wx:key="*this"
                   wx:for-index="imgIndex"
                   src="{{img}}" 
                   mode="aspectFill"
                   bindtap="previewImage"
                   data-index="{{imgIndex}}"></image>
          </view>
        </block>
      </view>
      
      <!-- 关联习惯 -->
      <view class="post-habit" wx:if="{{post.habitId}}" bindtap="viewHabitDetail">
        <view class="habit-icon" style="background-color: {{post.habitColor || '#4F7CFF'}}">
          <image src="{{post.habitIcon}}" mode="aspectFit"></image>
        </view>
        <text class="habit-name">{{post.habitName}}</text>
        <text class="iconfont icon-arrow-right"></text>
      </view>
    </view>
    
    <!-- 互动统计 -->
    <view class="post-stats">
      <text class="post-views">{{post.views}} 次查看</text>
      <text class="post-location" wx:if="{{post.location}}">{{post.location}}</text>
    </view>
    
    <!-- 互动按钮 -->
    <view class="post-actions">
      <view class="post-action {{post.isLiked ? 'active' : ''}}" bindtap="toggleLike">
        <text class="iconfont {{post.isLiked ? 'icon-heart-fill' : 'icon-heart'}}"></text>
        <text>{{post.likes}}</text>
      </view>
      <view class="post-action" bindtap="focusComment">
        <text class="iconfont icon-comment"></text>
        <text>{{post.comments.length}}</text>
      </view>
      <button class="post-action share-button" open-type="share">
        <text class="iconfont icon-share"></text>
        <text>分享</text>
      </button>
    </view>
    
    <!-- 点赞用户 -->
    <view class="liked-users" wx:if="{{post.likedUsers && post.likedUsers.length > 0}}">
      <view class="liked-avatars">
        <image class="liked-avatar" 
               wx:for="{{post.likedUsers}}" 
               wx:key="id" 
               src="{{item.avatar}}"
               mode="aspectFill"
               wx:if="{{index < 5}}"></image>
        <view class="liked-more" wx:if="{{post.likes > 5}}">+{{post.likes - 5}}</view>
      </view>
      <text class="liked-text">等人点赞了</text>
    </view>
    
    <!-- 评论区 -->
    <view class="comments-section">
      <view class="section-header">
        <text class="section-title">评论 {{post.comments.length}}</text>
        <view class="comment-sort" bindtap="toggleCommentSort">
          <text>{{commentSort === 'time' ? '按时间排序' : '按热度排序'}}</text>
          <text class="iconfont icon-arrow-down"></text>
        </view>
      </view>
      
      <!-- 评论列表 -->
      <view class="comments-list" wx:if="{{post.comments.length > 0}}">
        <view class="comment-item" wx:for="{{post.comments}}" wx:key="id">
          <image class="comment-avatar" src="{{item.userAvatar}}" mode="aspectFill" bindtap="viewUserProfile" data-id="{{item.userId}}"></image>
          <view class="comment-content">
            <view class="comment-header">
              <text class="comment-username" bindtap="viewUserProfile" data-id="{{item.userId}}">{{item.userName}}</text>
              <text class="comment-time">{{item.createdAt}}</text>
            </view>
            <text class="comment-text">{{item.content}}</text>
            
            <!-- 回复列表 -->
            <view class="replies" wx:if="{{item.replies && item.replies.length > 0}}">
              <view class="reply-item" wx:for="{{item.replies}}" wx:for-item="reply" wx:key="id">
                <text class="reply-username" bindtap="viewUserProfile" data-id="{{reply.userId}}">{{reply.userName}}</text>
                <text class="reply-text">: {{reply.content}}</text>
              </view>
              <view class="view-more-replies" wx:if="{{item.replyCount > item.replies.length}}" bindtap="viewAllReplies" data-id="{{item.id}}">
                查看全部{{item.replyCount}}条回复
              </view>
            </view>
            
            <!-- 评论操作 -->
            <view class="comment-actions">
              <view class="comment-action {{item.isLiked ? 'active' : ''}}" catchtap="likeComment" data-id="{{item.id}}" data-index="{{index}}">
                <text class="iconfont {{item.isLiked ? 'icon-heart-fill' : 'icon-heart'}}"></text>
                <text>{{item.likes}}</text>
              </view>
              <view class="comment-action" catchtap="replyComment" data-id="{{item.id}}" data-name="{{item.userName}}">
                <text class="iconfont icon-reply"></text>
                <text>回复</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- 空评论状态 -->
      <view class="empty-comments" wx:else>
        <image class="empty-icon" src="/images/icons/empty-comments.png" mode="aspectFit"></image>
        <text class="empty-text">暂无评论，快来抢沙发吧</text>
      </view>
      
      <!-- 加载更多 -->
      <view class="loading-more" wx:if="{{loadingMore}}">
        <view class="loading-spinner small"></view>
        <text class="loading-text">加载更多...</text>
      </view>
      
      <!-- 没有更多数据 -->
      <view class="no-more" wx:if="{{!loadingMore && !hasMore}}">
        <text>没有更多评论了</text>
      </view>
    </view>
  </view>
  
  <!-- 评论输入框 -->
  <view class="comment-input-container">
    <input class="comment-input" 
           placeholder="{{replyTo ? '回复 ' + replyTo + '：' : '说点什么...'}}" 
           value="{{commentText}}"
           focus="{{commentFocus}}"
           bindinput="inputComment"
           bindconfirm="submitComment" />
    <view class="send-btn {{commentText ? 'active' : ''}}" bindtap="submitComment">发送</view>
  </view>
  
  <!-- 动态不存在 -->
  <view class="error-state" wx:if="{{!loading && !post}}">
    <image class="error-icon" src="/images/icons/error.png" mode="aspectFit"></image>
    <text class="error-text">动态不存在或已被删除</text>
    <button class="back-btn" bindtap="navigateBack">返回</button>
  </view>
</view> 
