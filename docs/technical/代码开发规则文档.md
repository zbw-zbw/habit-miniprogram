# 习惯打卡小程序代码开发规则文档

## 1. 概述

本文档旨在规范习惯打卡小程序的开发过程，确保代码质量、可维护性和团队协作效率。所有参与项目开发的成员必须遵循本文档中的规则和建议。

## 2. 技术栈规范

### 2.1 前端技术栈

| 技术          | 版本   | 用途                |
| ----------- | ---- | ----------------- |
| 微信小程序原生框架   | 最新版  | 小程序基础框架           |
| Taro        | 3.x  | 多端统一开发框架          |
| React       | 18.x | UI构建库             |
| TypeScript  | 4.x  | 类型安全的JavaScript超集 |
| TailwindCSS | 3.x  | 原子化CSS框架          |
| Echarts     | 5.x  | 数据可视化图表库          |
| Dayjs       | 1.x  | 轻量级日期处理库          |

### 2.2 后端技术栈

| 技术         | 版本       | 用途                |
| ---------- | -------- | ----------------- |
| Node.js    | 18.x LTS | 服务端运行环境           |
| NestJS     | 9.x      | 后端框架              |
| TypeScript | 4.x      | 类型安全的JavaScript超集 |
| MongoDB    | 6.x      | 文档型数据库            |
| Redis      | 7.x      | 缓存数据库             |
| MySQL      | 8.x      | 关系型数据库            |
| JWT        | -        | 身份认证              |
| Bull       | 4.x      | 任务队列              |
| Jest       | 29.x     | 单元测试框架            |

## 3. 项目结构规范

### 3.1 小程序端目录结构

```
miniprogram/
├── components/         # 公共组件
│   ├── habit-card/     # 习惯卡片组件
│   ├── progress-ring/  # 进度环组件
│   └── ...
├── pages/              # 页面
│   ├── index/          # 首页
│   ├── habits/         # 习惯管理
│   ├── checkin/        # 打卡记录
│   └── ...
├── utils/              # 工具函数
│   ├── request.js      # 网络请求
│   ├── date.js         # 日期处理
│   └── ...
├── styles/             # 全局样式
│   ├── variables.wxss  # 变量定义
│   ├── common.wxss     # 公共样式
│   └── ...
├── images/             # 图片资源
├── services/           # 服务层
│   ├── api.js          # API接口
│   ├── habit.js        # 习惯相关服务
│   └── ...
├── models/             # 数据模型
├── store/              # 状态管理
├── app.js              # 应用入口
├── app.json            # 全局配置
└── app.wxss            # 全局样式
```

### 3.2 后端目录结构

```
server/
├── src/
│   ├── modules/        # 功能模块
│   │   ├── users/      # 用户模块
│   │   ├── habits/     # 习惯模块
│   │   └── ...
│   ├── common/         # 公共代码
│   │   ├── decorators/ # 装饰器
│   │   ├── filters/    # 过滤器
│   │   ├── guards/     # 守卫
│   │   └── ...
│   ├── config/         # 配置文件
│   ├── utils/          # 工具函数
│   ├── main.ts         # 入口文件
│   └── app.module.ts   # 根模块
├── test/               # 测试代码
├── dist/               # 编译输出
└── node_modules/       # 依赖包
```

## 4. 编码规范

### 4.1 通用规范

1. **文件命名**：
   
   - 使用小写字母和连字符（kebab-case）命名文件
   - 组件文件名应与组件名一致
   - 页面文件夹名与路由路径一致

2. **编码风格**：
   
   - 使用2个空格进行缩进
   - 使用分号结束语句
   - 使用单引号作为字符串引号
   - 每行代码长度不超过100个字符

3. **注释规范**：
   
   - 使用JSDoc风格的注释
   - 复杂逻辑必须添加注释
   - 公共函数必须有完整的参数和返回值注释

### 4.2 TypeScript规范

1. **类型定义**：
   
   - 所有变量、参数和返回值必须有明确的类型声明
   - 使用接口（interface）定义对象类型
   - 避免使用any类型，必要时使用unknown

2. **命名规范**：
   
   - 使用PascalCase命名类、接口、类型和枚举
   - 使用camelCase命名变量、函数和方法
   - 使用UPPER_SNAKE_CASE命名常量

3. **代码组织**：
   
   - 相关的类型定义放在单独的types.ts文件中
   - 每个文件只导出一个主要类/组件/函数

### 4.3 React & 小程序组件规范

1. **组件设计**：
   
   - 遵循单一职责原则，一个组件只做一件事
   - 使用函数组件和Hooks，避免使用类组件
   - 组件属性使用TypeScript接口定义

2. **状态管理**：
   
   - 局部状态使用useState和useReducer
   - 全局状态使用Context API或Redux
   - 避免组件间的直接状态共享

3. **生命周期**：
   
   - 使用useEffect管理副作用
   - 清理副作用以防止内存泄漏
   - 避免在渲染函数中执行副作用

4. **小程序特有规范**：
   
   - 页面生命周期函数放在文件顶部
   - 事件处理函数使用统一前缀（如handle）
   - 遵循小程序的数据更新机制

### 4.4 CSS/WXSS规范

1. **样式组织**：
   
   - 使用TailwindCSS的原子类优先
   - 复杂样式使用独立的WXSS文件
   - 组件样式使用BEM命名方法

2. **变量使用**：
   
   - 颜色、字体、间距等使用全局变量
   - 遵循设计规范文档中的视觉标准
   - 避免硬编码样式值

3. **响应式设计**：
   
   - 使用rpx单位适配不同屏幕
   - 关键布局使用flex或grid
   - 考虑不同设备的适配问题

## 5. API设计规范

### 5.1 RESTful API设计

1. **URL命名**：
   
   - 使用名词复数形式表示资源集合
   - 使用连字符（kebab-case）分隔多个单词
   - 版本号放在URL路径中（如/api/v1/）

2. **HTTP方法使用**：
   
   - GET：获取资源
   - POST：创建资源
   - PUT：更新资源（全量更新）
   - PATCH：更新资源（部分更新）
   - DELETE：删除资源

3. **状态码使用**：
   
   - 200：成功
   - 201：创建成功
   - 400：客户端错误
   - 401：未授权
   - 403：禁止访问
   - 404：资源不存在
   - 500：服务器错误

### 5.2 GraphQL API设计（如使用）

1. **类型定义**：
   
   - 使用明确的类型和字段
   - 提供详细的字段描述
   - 使用标量类型限制输入

2. **查询设计**：
   
   - 提供合适的查询粒度
   - 使用参数控制返回数据
   - 考虑分页和过滤需求

3. **变更设计**：
   
   - 遵循一致的命名约定
   - 返回变更后的完整对象
   - 提供明确的错误信息

### 5.3 前后端交互规范

1. **数据格式**：
   
   - 使用JSON作为数据交换格式
   - 日期使用ISO 8601格式
   - 保持字段命名一致性（camelCase）

2. **错误处理**：
   
   - 统一的错误响应格式
   - 包含错误码和描述信息
   - 提供有助于调试的上下文信息

3. **安全措施**：
   
   - 所有API请求使用HTTPS
   - 敏感数据传输必须加密
   - 实施适当的速率限制

## 6. 数据模型规范

### 6.1 核心数据模型

按照技术架构设计文档中的数据模型定义实现，主要包括：

1. **用户（User）**
2. **习惯（Habit）**
3. **打卡记录（CheckIn）**
4. **社区动态（Post）**
5. **挑战（Challenge）**

### 6.2 数据验证规则

1. **服务端验证**：
   
   - 使用验证装饰器（如class-validator）
   - 实施严格的输入验证
   - 防止注入攻击

2. **客户端验证**：
   
   - 表单提交前进行数据验证
   - 提供即时的错误反馈
   - 限制输入长度和格式

### 6.3 数据关系处理

1. **关联查询优化**：
   
   - 合理使用嵌入和引用关系
   - 预加载常用关联数据
   - 使用索引优化查询性能

2. **数据一致性**：
   
   - 使用事务确保关联操作的原子性
   - 实施乐观锁或悲观锁防止并发问题
   - 定期数据完整性检查

## 7. 性能优化规范

### 7.1 前端性能优化

1. **加载优化**：
   
   - 小程序分包加载
   - 图片资源压缩和CDN加速
   - 预加载关键资源

2. **渲染优化**：
   
   - 避免频繁setData
   - 使用虚拟列表处理长列表
   - 避免不必要的重渲染

3. **交互优化**：
   
   - 防抖和节流处理
   - 异步操作状态反馈
   - 骨架屏提升体验

### 7.2 后端性能优化

1. **数据库优化**：
   
   - 合理设计索引
   - 查询语句优化
   - 分页和限制结果集大小

2. **缓存策略**：
   
   - 使用Redis缓存热点数据
   - 实施多级缓存机制
   - 设置合理的缓存过期策略

3. **并发处理**：
   
   - 使用连接池管理数据库连接
   - 任务队列处理耗时操作
   - 水平扩展提升并发能力

## 8. 安全规范

### 8.1 认证与授权

1. **用户认证**：
   
   - 微信登录认证
   - JWT令牌管理
   - 会话安全控制

2. **权限控制**：
   
   - 基于角色的访问控制（RBAC）
   - API级别的权限验证
   - 最小权限原则

### 8.2 数据安全

1. **敏感数据处理**：
   
   - 敏感信息加密存储
   - 传输层TLS加密
   - 数据脱敏展示

2. **输入验证**：
   
   - 所有用户输入严格验证
   - 防XSS、CSRF攻击
   - SQL注入防护

### 8.3 小程序特有安全

1. **小程序登录流程**：
   
   - 正确实现code换取session_key
   - 数据签名验证
   - 防重放攻击

2. **敏感接口保护**：
   
   - 支付相关接口额外验证
   - 频率限制和异常监控
   - 多因素认证

## 9. 测试规范

### 9.1 单元测试

1. **测试覆盖要求**：
   
   - 核心业务逻辑覆盖率>80%
   - 工具函数覆盖率>90%
   - API接口覆盖率>70%

2. **测试组织**：
   
   - 测试文件与源文件结构一致
   - 使用describe和it组织测试用例
   - 使用前置和后置钩子管理测试环境

### 9.2 集成测试

1. **API测试**：
   
   - 覆盖所有API端点
   - 测试各种参数组合
   - 验证错误处理逻辑

2. **流程测试**：
   
   - 测试完整业务流程
   - 模拟真实用户场景
   - 验证数据一致性

### 9.3 端到端测试

1. **UI测试**：
   
   - 关键页面功能测试
   - 不同设备兼容性测试
   - 用户操作流程测试

2. **性能测试**：
   
   - 负载测试关键API
   - 并发用户模拟
   - 响应时间基准测试

## 10. 版本控制与协作规范

### 10.1 Git工作流

1. **分支策略**：
   
   - master/main：稳定版本
   - develop：开发主分支
   - feature/*：功能开发分支
   - release/*：发布准备分支
   - hotfix/*：紧急修复分支

2. **提交规范**：
   
   - 使用约定式提交（Conventional Commits）
   - 格式：`<type>(<scope>): <description>`
   - 类型包括：feat, fix, docs, style, refactor, perf, test, chore

3. **代码审查**：
   
   - 所有代码通过Pull Request合并
   - 至少一名团队成员审查通过
   - 确保通过自动化测试

### 10.2 发布流程

1. **版本号管理**：
   
   - 遵循语义化版本（SemVer）
   - 主版本.次版本.修订号（X.Y.Z）
   - 版本号变更规则明确

2. **发布检查清单**：
   
   - 功能测试通过
   - 性能指标达标
   - 文档更新完成
   - 发布说明准备就绪

3. **灰度发布策略**：
   
   - 小范围用户测试
   - 监控关键指标
   - 问题快速响应机制

## 11. 文档规范

### 11.1 代码文档

1. **内联文档**：
   
   - 复杂函数添加JSDoc注释
   - 关键算法添加实现说明
   - 特殊处理逻辑添加原因说明

2. **API文档**：
   
   - 使用Swagger或类似工具自动生成
   - 包含参数、返回值和示例
   - 错误码和处理说明

### 11.2 项目文档

1. **README**：
   
   - 项目简介和目标
   - 安装和运行说明
   - 技术栈和依赖说明

2. **架构文档**：
   
   - 系统架构图
   - 模块职责说明
   - 关键流程图

3. **开发指南**：
   
   - 环境搭建步骤
   - 常见问题解答
   - 贡献指南

## 12. 差异化功能开发规范

基于差异化组合报告和核心竞争力文档，以下功能开发需特别注意：

### 12.1 科学化习惯设计系统

1. **实现原则**：
   
   - 严格遵循行为科学理论
   - 确保习惯拆解逻辑科学合理
   - 提供清晰的习惯养成路径

2. **关键指标**：
   
   - 习惯完成率提升
   - 用户持续使用时间
   - 习惯养成成功率

### 12.2 AI个性化引擎

1. **实现原则**：
   
   - 数据隐私保护优先
   - 算法透明度和可解释性
   - 持续学习和优化机制

2. **关键指标**：
   
   - 推荐准确率
   - 用户采纳率
   - 习惯优化效果

### 12.3 真实社交激励系统

1. **实现原则**：
   
   - 真实身份验证
   - 积极健康的社交氛围
   - 有效的激励和问责机制

2. **关键指标**：
   
   - 社交互动频率
   - 互助效果评估
   - 社区活跃度

## 13. 持续集成与部署

### 13.1 CI/CD流程

1. **持续集成**：
   
   - 提交代码触发自动构建
   - 运行自动化测试
   - 代码质量检查

2. **持续部署**：
   
   - 开发环境自动部署
   - 测试环境手动触发
   - 生产环境审批后部署

### 13.2 环境管理

1. **环境隔离**：
   
   - 开发环境
   - 测试环境
   - 预发布环境
   - 生产环境

2. **配置管理**：
   
   - 环境变量管理
   - 敏感信息加密
   - 配置中心集中管理

## 14. 监控与运维

### 14.1 日志规范

1. **日志级别**：
   
   - ERROR：影响系统运行的错误
   - WARN：潜在问题警告
   - INFO：重要操作信息
   - DEBUG：调试信息

2. **日志内容**：
   
   - 时间戳
   - 日志级别
   - 模块/服务名
   - 用户标识（脱敏）
   - 详细信息
   - 上下文数据

### 14.2 监控指标

1. **系统监控**：
   
   - 服务器资源使用率
   - API响应时间
   - 错误率和异常数
   - 数据库性能

2. **业务监控**：
   
   - 日活跃用户数
   - 关键功能使用率
   - 用户留存指标
   - 习惯完成率

### 14.3 告警机制

1. **告警级别**：
   
   - P0：紧急问题，需立即处理
   - P1：重要问题，2小时内处理
   - P2：常规问题，24小时内处理
   - P3：低优先级问题，计划处理

2. **告警渠道**：
   
   - 即时消息（微信/钉钉）
   - 邮件通知
   - 电话告警（紧急问题）

## 15. 项目管理规范

### 15.1 任务管理

1. **任务拆分**：
   
   - 遵循SMART原则
   - 工作量评估准确
   - 明确验收标准

2. **优先级管理**：
   
   - P0：阻塞项目的关键问题
   - P1：影响主要功能的重要任务
   - P2：常规功能开发任务
   - P3：优化和改进任务

### 15.2 进度管理

1. **敏捷开发流程**：
   
   - 2周一个迭代周期
   - 每日站会同步进度
   - 迭代评审和回顾

2. **里程碑管理**：
   
   - 明确里程碑目标
   - 可量化的完成标准
   - 及时调整和风险管理

## 16. 总结

本文档提供了习惯打卡小程序开发的全面规范指导，涵盖了技术选型、项目结构、编码规范、API设计、测试、安全等多个方面。所有团队成员应当熟悉并遵循这些规范，确保项目的顺利进行和高质量交付。

随着项目的推进，本文档将持续更新和完善，以适应项目发展的需要。 