<!--pages/checkin/checkin.wxml-->
<view class="container">
  <!-- ä¸»å†…å®¹åŒº -->
  <view class="content">
    <!-- å½“å‰æ­£åœ¨æ‰“å¡çš„ä¹ æƒ¯ -->
    <view class="section-title">æ­£åœ¨æ‰“å¡</view>
    <view class="current-habit-card">
      <view class="habit-info">
        <view class="habit-icon" style="background-color: {{habit.color || '#4F7CFF'}}30; color: {{habit.color || '#4F7CFF'}}">
          <text class="iconfont icon-{{habit.icon || 'book'}}"></text>
        </view>
        <view class="habit-meta">
          <view class="habit-name">{{habitName || 'é˜…è¯»'}}</view>
          <view class="habit-desc">{{habit.description || 'æ¯å¤©30åˆ†é’Ÿ'}}</view>
        </view>
      </view>
      
      <view class="habit-actions">
        <view class="streak-text">å·²è¿ç»­{{habit.stats.currentStreak || 0}}å¤©</view>
        <button class="checkin-btn" bindtap="toggleForm" wx:if="{{!showForm}}">æ‰“å¡</button>
        <button class="checkin-btn cancel" bindtap="toggleForm" wx:else>å–æ¶ˆ</button>
      </view>

      <!-- æ‰“å¡è¡¨å• -->
      <view class="checkin-form" wx:if="{{showForm}}">
        <view class="form-title">ä»Šæ—¥{{habitName || 'é˜…è¯»'}}</view>
        
        <!-- æ—¶é•¿è®¡æ—¶å™¨ -->
        <view class="form-item">
          <view class="form-label">{{habitName || 'é˜…è¯»'}}æ—¶é•¿</view>
          <view class="timer-display">{{timer.displayTime}}</view>
          <view class="timer-controls">
            <view class="timer-btn reset" bindtap="resetTimer">
              <text class="iconfont icon-reset"></text>
            </view>
            <block wx:if="{{timer.isRunning}}">
              <view class="timer-btn stop" bindtap="stopTimer">
                <text class="iconfont icon-pause"></text>
              </view>
            </block>
            <block wx:else>
              <view class="timer-btn start" bindtap="startTimer">
                <text class="iconfont icon-play"></text>
              </view>
            </block>
          </view>
        </view>
        
        <!-- å†…å®¹è¾“å…¥ -->
        <view class="form-item">
          <view class="form-label">{{habitName || 'é˜…è¯»'}}å†…å®¹</view>
          <input class="form-input" placeholder="è¾“å…¥å†…å®¹" value="{{formData.content}}" bindinput="inputContent" />
        </view>
        
        <!-- æ„Ÿå—è¾“å…¥ -->
        <view class="form-item">
          <view class="form-label">{{habitName || 'é˜…è¯»'}}æ„Ÿå—</view>
          <textarea class="form-textarea" placeholder="åˆ†äº«ä½ çš„æ„Ÿå—..." value="{{formData.note}}" bindinput="inputNote"></textarea>
        </view>
        
        <!-- å¿ƒæƒ…é€‰æ‹© -->
        <view class="form-item">
          <view class="form-label">ä»Šæ—¥å¿ƒæƒ…</view>
          <view class="mood-selector">
            <view class="mood-option {{formData.mood === 'great' ? 'selected' : ''}}" bindtap="selectMood" data-mood="great">
              <view class="mood-emoji">ğŸ˜Š</view>
              <view class="mood-label">è¶…æ£’</view>
            </view>
            <view class="mood-option {{formData.mood === 'good' ? 'selected' : ''}}" bindtap="selectMood" data-mood="good">
              <view class="mood-emoji">ğŸ˜Œ</view>
              <view class="mood-label">ä¸é”™</view>
            </view>
            <view class="mood-option {{formData.mood === 'neutral' ? 'selected' : ''}}" bindtap="selectMood" data-mood="neutral">
              <view class="mood-emoji">ğŸ¤”</view>
              <view class="mood-label">ä¸€èˆ¬</view>
            </view>
            <view class="mood-option {{formData.mood === 'bad' ? 'selected' : ''}}" bindtap="selectMood" data-mood="bad">
              <view class="mood-emoji">ğŸ˜´</view>
              <view class="mood-label">ä¸ä½³</view>
            </view>
            <view class="mood-option {{formData.mood === 'terrible' ? 'selected' : ''}}" bindtap="selectMood" data-mood="terrible">
              <view class="mood-emoji">ğŸ˜¢</view>
              <view class="mood-label">ç³Ÿç³•</view>
            </view>
          </view>
        </view>
        
        <!-- ç…§ç‰‡ä¸Šä¼  -->
        <view class="form-item">
          <view class="form-label">æ·»åŠ ç…§ç‰‡</view>
          <view class="photo-upload" bindtap="chooseImage" wx:if="{{formData.photos.length < 9}}">
            <text class="iconfont icon-camera"></text>
            <view class="upload-text">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</view>
          </view>
          <view class="photo-list" wx:if="{{formData.photos.length > 0}}">
            <view class="photo-item" wx:for="{{formData.photos}}" wx:key="*this">
              <image class="photo-image" src="{{item}}" mode="aspectFill"></image>
              <view class="photo-delete" bindtap="deleteImage" data-index="{{index}}">
                <text class="iconfont icon-close"></text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- æäº¤æŒ‰é’® -->
        <button class="submit-btn" bindtap="submitCheckin">å®Œæˆæ‰“å¡</button>
      </view>
    </view>
    
    <!-- ä»Šæ—¥å¾…æ‰“å¡ -->
    <view class="section-title">ä»Šæ—¥å¾…æ‰“å¡</view>
    <view class="habits-list">
      <!-- ä½¿ç”¨çœŸå®çš„ä»Šæ—¥å¾…æ‰“å¡ä¹ æƒ¯æ•°æ® -->
      <block wx:if="{{todayHabits && todayHabits.length > 0}}">
        <habit-card 
          wx:for="{{todayHabits}}" 
          wx:key="id" 
          habit="{{item}}" 
          stats="{{item.stats}}"
          wx:if="{{!showForm}}"
          bindcheckin="navigateToCheckin"
          data-id="{{item.id}}">
        </habit-card>
      </block>
      <block wx:else>
        <view class="empty-habits">
          <text>ä»Šå¤©æ²¡æœ‰å…¶ä»–éœ€è¦æ‰“å¡çš„ä¹ æƒ¯</text>
        </view>
      </block>
    </view>

    <!-- å·²å®Œæˆä¹ æƒ¯ -->
    <view class="section-title">å·²å®Œæˆ</view>
    <view class="habits-list">
      <habit-card 
        wx:for="{{completedHabits}}" 
        wx:key="id" 
        habit="{{item}}" 
        stats="{{item.stats}}"
        showCheckinButton="{{false}}">
      </habit-card>
    </view>
    
    <!-- æœ¬å‘¨è¿›åº¦ -->
    <view class="section-title">æœ¬å‘¨è¿›åº¦</view>
    <view class="calendar-card">
      <view class="calendar-header">
        <view class="calendar-title">æœ¬å‘¨</view>
        <view class="calendar-action" bindtap="viewWeeklyProgress">æŸ¥çœ‹æ›´å¤š</view>
      </view>
      
      <view class="calendar-days">
        <view class="day-column" wx:for="{{weekDays}}" wx:key="weekday">
          <view class="day-label">{{item.weekday}}</view>
          <view class="day-circle {{item.isToday ? 'today' : ''}} {{item.isCompleted ? 'completed' : ''}} {{item.isDisabled ? 'disabled' : ''}}">
            {{item.day}}
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æ‰“å¡æˆåŠŸå¼¹çª— -->
  <view class="success-popup" wx:if="{{showSuccessPopup}}">
    <view class="success-popup-content">
      <view class="success-icon">âœ“</view>
      <view class="success-title">{{successMessage.title}}</view>
      <view class="success-subtitle">{{successMessage.subtitle}}</view>
      
      <view class="success-stats">
        <view class="stats-item">
          <view class="stats-value">{{successMessage.streak}}</view>
          <view class="stats-label">è¿ç»­å¤©æ•°</view>
        </view>
        <view class="stats-item">
          <view class="stats-value">+{{successMessage.points}}</view>
          <view class="stats-label">ç§¯åˆ†</view>
        </view>
      </view>
      
      <view class="success-actions">
        <button class="success-btn share" bindtap="shareCheckin">åˆ†äº«</button>
        <button class="success-btn close" bindtap="closeSuccessPopup">ç¡®å®š</button>
      </view>
    </view>
  </view>
</view>
