<!--pages/community/post-detail/post-detail.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
  
  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view class="content" wx:if="{{!loading}}">
    <!-- åŠ¨æ€è¯¦æƒ… -->
    <post-card 
      post="{{post}}" 
      isDetail="{{true}}" 
      bind:viewUser="viewUserProfile"
      bind:like="likePost"
      bind:comment="focusCommentInput"
      bind:previewImage="previewImage"
      bind:viewTag="viewTag">
    </post-card>
    
    <!-- è¯„è®ºåŒº -->
    <view class="comments-section">
      <view class="section-title">è¯„è®º {{post.comments}}</view>
      
      <!-- ç©ºè¯„è®ºæç¤º -->
      <view class="empty-comments" wx:if="{{comments.length === 0}}">
        <text class="iconfont icon-comment"></text>
        <view class="empty-text">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§</view>
      </view>
      
      <!-- è¯„è®ºåˆ—è¡¨ -->
      <view class="comment-list" wx:else>
        <view class="comment-item" wx:for="{{comments}}" wx:key="id">
          <!-- è¯„è®ºä¸»ä½“ -->
          <view class="comment-main">
            <image class="comment-avatar" 
                   src="{{item.userAvatar}}" 
                   mode="aspectFill"
                   bindtap="viewUserProfile" 
                   data-id="{{item.userId}}"></image>
            
            <view class="comment-content">
              <view class="comment-header">
                <view class="comment-username" bindtap="viewUserProfile" data-id="{{item.userId}}">
                  {{item.userName}}
                </view>
                <view class="comment-time">{{item.createdAt}}</view>
              </view>
              
              <view class="comment-text">{{item.content}}</view>
              
              <!-- è¯„è®ºæ“ä½œ -->
              <view class="comment-actions">
                <view class="comment-action {{item.isLiked ? 'active' : ''}}" 
                      bindtap="likeComment" 
                      data-index="{{index}}">
                  <text class="iconfont {{item.isLiked ? 'icon-heart-fill' : 'icon-heart'}}"></text>
                  <text>{{item.likes}}</text>
                </view>
                
                <view class="comment-action" 
                      bindtap="replyComment" 
                      data-index="{{index}}"
                      data-username="{{item.userName}}">
                  <text class="iconfont icon-comment"></text>
                  <text>å›å¤</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- å›å¤åˆ—è¡¨ -->
          <view class="reply-list" wx:if="{{item.replies && item.replies.length > 0}}">
            <view class="reply-item" wx:for="{{item.replies}}" wx:key="id" wx:for-item="reply" wx:for-index="replyIndex">
              <image class="reply-avatar" 
                     src="{{reply.userAvatar || reply.user.avatar}}" 
                     mode="aspectFill"
                     bindtap="viewUserProfile" 
                     data-id="{{reply.userId || reply.user.id}}"></image>
              
              <view class="reply-content">
                <view class="reply-header">
                  <view class="reply-username" bindtap="viewUserProfile" data-id="{{reply.userId || reply.user.id}}">
                    {{reply.userName || reply.user.nickname || reply.user.username}}
                  </view>
                  <text class="reply-to" wx:if="{{reply.replyTo}}">å›å¤</text>
                  <view class="reply-to-username" wx:if="{{reply.replyTo}}" bindtap="viewUserProfile" data-id="{{reply.replyToId}}">
                    @{{reply.replyTo}}
                  </view>
                  <view class="reply-time">{{reply.createdAt}}</view>
                </view>
                
                <view class="reply-text">{{reply.content}}</view>
                
                <!-- å›å¤æ“ä½œ -->
                <view class="reply-actions">
                  <view class="reply-action {{reply.isLiked ? 'active' : ''}}" 
                        catchtap="likeReply" 
                        data-comment-index="{{index}}"
                        data-reply-index="{{replyIndex}}">
                    <text class="iconfont {{reply.isLiked ? 'icon-heart-fill' : 'icon-heart'}}"></text>
                    <text>{{reply.likes || 0}}</text>
                  </view>
                  
                  <view class="reply-action" 
                        catchtap="replyToReply" 
                        data-comment-index="{{index}}"
                        data-reply-index="{{replyIndex}}"
                        data-username="{{reply.userName || reply.user.nickname || reply.user.username}}">
                    <text class="iconfont icon-comment"></text>
                    <text>å›å¤</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- è¯„è®ºè¾“å…¥åŒºåŸŸ -->
  <view class="comment-input-area">
    <!-- å›å¤æç¤º -->
    <view class="reply-tip" wx:if="{{replyTo}}">
      <text>å›å¤ @{{replyTo.username}}</text>
      <text class="cancel-reply" bindtap="cancelReply">å–æ¶ˆ</text>
    </view>
    
    <view class="comment-input-container">
      <input class="comment-input" 
             placeholder="{{replyTo ? 'å›å¤ @' + replyTo.username + '...' : 'å†™è¯„è®º...'}}" 
             value="{{commentContent}}"
             focus="{{focusComment}}"
             bindinput="inputComment"
             bindconfirm="submitComment"
             confirm-type="send"
             cursor-spacing="10"></input>
      
      <view class="input-actions">
        <view class="input-action" bindtap="toggleEmojiPanel">
          <text class="iconfont icon-emoji"></text>
        </view>
        
        <view class="input-action send {{commentContent ? 'active' : ''}}" bindtap="submitComment">
          <text>å‘é€</text>
        </view>
      </view>
    </view>
    
    <!-- è¡¨æƒ…é¢æ¿ -->
    <view class="emoji-panel" wx:if="{{showEmojiPanel}}">
      <view class="emoji-list">
        <view class="emoji-item" wx:for="{{['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¤”', 'ğŸ‘', 'ğŸ‰', 'â¤ï¸', 'ğŸ˜­', 'ğŸ™', 'ğŸ¤£', 'ğŸ˜…', 'ğŸ˜˜', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤—', 'ğŸ˜´', 'ğŸ¤©', 'ğŸ˜‡']}}" wx:key="*this" bindtap="selectEmoji" data-emoji="{{item}}">
          {{item}}
        </view>
      </view>
    </view>
  </view>
</view> 
