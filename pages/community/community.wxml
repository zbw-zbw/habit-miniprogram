<!--pages/community/community.wxml-->
<view class="container">
  <!-- 顶部导航栏 -->
  <view class="navbar">
    <view class="navbar-left">
      <text class="title">社区</text>
    </view>
    <view class="navbar-right">
      <view class="icon-btn" bindtap="navigateToNotifications">
        <text class="iconfont icon-notification"></text>
      </view>
      <view class="icon-btn" bindtap="navigateToSearch">
        <text class="iconfont icon-search"></text>
      </view>
    </view>
  </view>
  
  <!-- 标签页导航 -->
  <view class="tabs">
    <view class="tab-item {{activeTab === 'follow' ? 'active' : ''}}" bindtap="switchTab" data-tab="follow">关注</view>
    <view class="tab-item {{activeTab === 'discover' ? 'active' : ''}}" bindtap="switchTab" data-tab="discover">发现</view>
    <view class="tab-item {{activeTab === 'nearby' ? 'active' : ''}}" bindtap="switchTab" data-tab="nearby">附近</view>
    <view class="tab-item {{activeTab === 'rank' ? 'active' : ''}}" bindtap="switchTab" data-tab="rank">排行</view>
  </view>
  
  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
  
  <!-- 主内容区域 -->
  <view class="content" wx:if="{{!loading}}">
    <!-- 好友故事 -->
    <view class="friends-section">
      <scroll-view class="friends-scroll" scroll-x="true" enable-flex="true" enhanced="true" show-scrollbar="false">
        <view class="friend-item" wx:for="{{friends}}" wx:key="id" bindtap="viewUserProfile" data-id="{{item.id}}">
          <view class="friend-avatar-container {{item.hasUpdate ? 'has-update' : ''}}">
            <image class="friend-avatar" src="{{item.avatar}}" mode="aspectFill"></image>
          </view>
          <text class="friend-name">{{item.name}}</text>
        </view>
      </scroll-view>
    </view>
    
    <!-- 小组列表 -->
    <view class="groups-section">
      <view class="section-header">
        <text class="section-title">热门小组</text>
        <text class="section-more" bindtap="viewAllGroups">查看全部</text>
      </view>
      
      <scroll-view class="groups-scroll" scroll-x="true" enhanced="true" show-scrollbar="false">
        <view class="group-item" 
              wx:for="{{groups}}" 
              wx:key="id" 
              bindtap="viewGroupDetail"
              data-id="{{item.id}}">
          <image class="group-avatar" src="{{item.avatar}}" mode="aspectFill"></image>
          <view class="group-info">
            <text class="group-name">{{item.name}}</text>
            <text class="group-members">{{item.membersCount}}人</text>
          </view>
        </view>
        
        <!-- 如果没有小组数据，显示空状态 -->
        <view class="empty-state" wx:if="{{groups.length === 0}}">
          <text>暂无小组数据</text>
        </view>
      </scroll-view>
    </view>
    
    <!-- 热门挑战 -->
    <view class="challenges-section">
      <view class="section-header">
        <text class="section-title">热门挑战</text>
        <text class="section-more" bindtap="viewAllChallenges">查看全部</text>
      </view>
      
      <scroll-view class="challenges-scroll" scroll-x="true" enable-flex="true" enhanced="true" show-scrollbar="false">
        <view class="challenge-item" 
              wx:for="{{challenges}}" 
              wx:key="id" 
              bindtap="viewChallengeDetail"
              data-id="{{item.id}}">
          <image class="challenge-image" src="{{item.image}}" mode="aspectFill"></image>
          <view class="challenge-overlay"></view>
          <view class="challenge-info">
            <text class="challenge-title">{{item.title}}</text>
            <text class="challenge-participants">{{item.participants}}人参与</text>
          </view>
          <view class="challenge-join {{item.isJoined ? 'joined' : ''}}" 
                catchtap="joinChallenge" 
                data-id="{{item.id}}"
                data-index="{{index}}">
            <text class="iconfont {{item.isJoined ? 'icon-check' : 'icon-plus'}}"></text>
          </view>
        </view>
        
        <!-- 空状态展示 -->
        <view class="empty-challenge" wx:if="{{!challenges || challenges.length === 0}}">
          <view class="empty-challenge-item">
            <view class="empty-challenge-icon">
              <text class="iconfont icon-challenge"></text>
            </view>
            <text class="empty-challenge-text">暂无挑战</text>
            <view class="empty-challenge-btn" catchtap="viewAllChallenges">创建挑战</view>
          </view>
          <view class="empty-challenge-item">
            <view class="empty-challenge-icon">
              <text class="iconfont icon-calendar"></text>
            </view>
            <text class="empty-challenge-text">参与挑战</text>
            <view class="empty-challenge-btn" catchtap="viewAllChallenges">浏览更多</view>
          </view>
        </view>
      </scroll-view>
    </view>
    
    <!-- 动态列表 -->
    <view class="posts-section">
      <view class="section-header">
        <text class="section-title">动态</text>
      </view>
      
      <view class="post-item" wx:for="{{posts}}" wx:key="id">
        <!-- 用户信息 -->
        <view class="post-header">
          <view class="post-user" bindtap="viewUserProfile" data-id="{{item.userId}}">
            <image class="post-avatar" src="{{item.userAvatar}}" mode="aspectFill"></image>
            <view class="post-user-info">
              <view class="post-username">{{item.userName}}</view>
              <view class="post-meta">{{item.createdAt}} · {{item.habitName}}</view>
            </view>
          </view>
          <view class="post-more">
            <text class="iconfont icon-more"></text>
          </view>
        </view>
        
        <!-- 动态内容 -->
        <view class="post-content" bindtap="viewPostDetail" data-id="{{item.id}}">
          <text class="post-text">{{item.content}}</text>
          
          <!-- 标签 -->
          <view class="post-tags" wx:if="{{item.tags && item.tags.length > 0}}">
            <view class="post-tag" wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag">
              <text class="iconfont icon-tag"></text>
              <text>{{tag}}</text>
            </view>
          </view>
          
          <!-- 图片 -->
          <view class="post-images" wx:if="{{item.images && item.images.length > 0}}">
            <image 
              class="post-image {{item.images.length === 1 ? 'single' : ''}}" 
              wx:for="{{item.images}}" 
              wx:key="*this" 
              wx:for-item="image" 
              src="{{image}}" 
              mode="aspectFill"
            ></image>
          </view>
        </view>
        
        <!-- 互动按钮 -->
        <view class="post-actions">
          <view class="post-action {{item.isLiked ? 'active' : ''}}" bindtap="likePost" data-id="{{item.id}}" data-index="{{index}}">
            <text class="iconfont {{item.isLiked ? 'icon-heart-fill' : 'icon-heart'}}"></text>
            <text>{{item.likes}}</text>
          </view>
          <view class="post-action" bindtap="commentPost" data-id="{{item.id}}">
            <text class="iconfont icon-comment"></text>
            <text>{{item.comments}}</text>
          </view>
          <view class="post-action" bindtap="sharePost" data-id="{{item.id}}">
            <text class="iconfont icon-share"></text>
            <text>分享</text>
          </view>
        </view>
      </view>
      
      <!-- 加载更多 -->
      <view class="loading-more" wx:if="{{loading && posts.length > 0}}">
        <view class="loading-spinner small"></view>
        <text class="loading-text">加载更多...</text>
      </view>
      
      <!-- 没有更多数据 -->
      <view class="no-more" wx:if="{{!loading && !hasMore && posts.length > 0}}">
        <text>没有更多数据了</text>
      </view>
    </view>
  </view>
  
  <!-- 发布按钮 -->
  <view class="create-post-btn" bindtap="showCreatePost">
    <text class="iconfont icon-edit"></text>
  </view>
  
  <!-- 发布动态弹窗 -->
  <view class="post-modal-mask" wx:if="{{showPostModal}}" bindtap="hideCreatePost">
    <view class="post-modal" catchtap="stopPropagation">
      <view class="post-modal-header">
        <text class="post-modal-title">发布动态</text>
        <text class="post-modal-close iconfont icon-close" bindtap="hideCreatePost"></text>
      </view>
      
      <view class="post-modal-content">
        <textarea class="post-textarea" 
                  placeholder="分享你的习惯打卡心得..." 
                  maxlength="500" 
                  bindinput="inputContent"
                  value="{{newPost.content}}"
                  auto-focus="true"></textarea>
        
        <!-- 已选图片 -->
        <view class="selected-images" wx:if="{{newPost.images.length > 0}}">
          <view class="image-item" wx:for="{{newPost.images}}" wx:key="*this">
            <image class="preview-image" src="{{item}}" mode="aspectFill"></image>
            <view class="remove-image" bindtap="removeImage" data-index="{{index}}">
              <text class="iconfont icon-close"></text>
            </view>
          </view>
        </view>
        
        <!-- 已选标签 -->
        <view class="selected-tags" wx:if="{{newPost.tags.length > 0}}">
          <view class="tag-item" wx:for="{{newPost.tags}}" wx:key="*this">
            <text>{{item}}</text>
            <text class="remove-tag" bindtap="removeTag" data-index="{{index}}">×</text>
          </view>
        </view>
      </view>
      
      <view class="post-modal-footer">
        <view class="post-tools">
          <view class="post-tool" bindtap="chooseImage">
            <text class="iconfont icon-image"></text>
          </view>
          <view class="post-tool" bindtap="showTagSelector">
            <text class="iconfont icon-tag"></text>
          </view>
        </view>
        
        <button class="post-submit-btn {{newPost.content ? 'active' : ''}}" bindtap="submitPost" disabled="{{!newPost.content}}">
          发布
        </button>
      </view>
    </view>
  </view>
</view>
