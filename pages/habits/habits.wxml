<!--pages/habits/habits.wxml-->
<view class="container">
  <!-- 顶部标签栏 -->
  <view class="tabs">
    <scroll-view scroll-x class="tabs-scroll" scroll-with-animation enable-flex>
      <view 
        wx:for="{{categories}}" 
        wx:key="index" 
        class="tab-item {{activeTab === index ? 'active' : ''}}"
        bindtap="onTabChange"
        data-index="{{index}}">
        {{item}}
      </view>
    </scroll-view>
  </view>
  

  
  <!-- 日历选择 -->
  <view class="calendar-card">
    <view class="card-header">
      <view class="card-title">{{currentMonth || '本月'}}</view>
      <view class="card-actions">
        <view class="action-btn" bindtap="changeMonth" data-direction="prev">
          <text class="iconfont icon-left"></text>
        </view>
        <view class="action-btn" bindtap="changeMonth" data-direction="next">
          <text class="iconfont icon-right"></text>
        </view>
      </view>
    </view>
    
    <view class="calendar-weekdays">
      <view class="weekday">一</view>
      <view class="weekday">二</view>
      <view class="weekday">三</view>
      <view class="weekday">四</view>
      <view class="weekday">五</view>
      <view class="weekday">六</view>
      <view class="weekday">日</view>
    </view>
    
    <view class="calendar-grid">
      <view 
        wx:for="{{calendarDays}}" 
        wx:key="date" 
        class="calendar-day {{item.isCurrentMonth ? '' : 'other-month'}} {{item.isSelected ? 'selected' : ''}} {{item.isToday ? 'today' : ''}}"
        bindtap="selectDate"
        data-date="{{item.date}}"
      >
        {{item.day}}
      </view>
    </view>
    
    <view class="calendar-footer">
      <view class="date-display">{{selectedDate || '今日'}}的习惯</view>
    </view>
  </view>
  
  <!-- 习惯列表 -->
  <view class="habits-list">
    <block wx:if="{{loading}}">
      <view class="loading">
        <view class="loading-spinner"></view>
        <view class="loading-text">加载中...</view>
      </view>
    </block>
    <block wx:elif="{{habits.length === 0}}">
      <view class="empty">
        <view class="empty-icon">📝</view>
        <view class="empty-text">暂无习惯，点击右下角"+"创建</view>
        <button class="btn btn-primary" bindtap="createHabit">创建习惯</button>
      </view>
    </block>
    <block wx:else>
      <habit-card 
        wx:for="{{habits}}" 
        wx:key="id" 
        habit="{{item}}" 
        stats="{{habitStats[item.id]}}"
        bindcheckin="onCheckin"
        binddelete="onDeleteHabit">
      </habit-card>
    </block>
  </view>
  
  <!-- 浮动按钮 -->
  <fab-button icon="add" bindclick="createHabit"></fab-button>
  
  <!-- 分类选择模态框 -->
  <view class="modal {{showCategoryModal ? 'show' : ''}}" catchtouchmove="true">
    <view class="modal-mask" bindtap="closeCategoryModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title">选择分类</view>
        <view class="modal-close" bindtap="closeCategoryModal">×</view>
      </view>
      <view class="modal-body">
        <view class="category-list">
          <view 
            wx:for="{{categories}}" 
            wx:key="index" 
            class="category-item {{activeTab === index ? 'active' : ''}}"
            bindtap="onTabChange"
            data-index="{{index}}">
            {{item}}
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 排序选择模态框 -->
  <view class="modal {{showSortModal ? 'show' : ''}}" catchtouchmove="true">
    <view class="modal-mask" bindtap="closeSortModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title">排序方式</view>
        <view class="modal-close" bindtap="closeSortModal">×</view>
      </view>
      <view class="modal-body">
        <view class="sort-list">
          <view 
            class="sort-item {{sortType === 'default' ? 'active' : ''}}"
            bindtap="setSortType"
            data-type="default"
            data-order="asc">
            <text>默认排序</text>
            <text class="iconfont icon-check" wx:if="{{sortType === 'default'}}"></text>
          </view>
          <view 
            class="sort-item {{sortType === 'name' && sortOrder === 'asc' ? 'active' : ''}}"
            bindtap="setSortType"
            data-type="name"
            data-order="asc">
            <text>名称升序 (A-Z)</text>
            <text class="iconfont icon-check" wx:if="{{sortType === 'name' && sortOrder === 'asc'}}"></text>
          </view>
          <view 
            class="sort-item {{sortType === 'name' && sortOrder === 'desc' ? 'active' : ''}}"
            bindtap="setSortType"
            data-type="name"
            data-order="desc">
            <text>名称降序 (Z-A)</text>
            <text class="iconfont icon-check" wx:if="{{sortType === 'name' && sortOrder === 'desc'}}"></text>
          </view>
          <view 
            class="sort-item {{sortType === 'createdAt' && sortOrder === 'desc' ? 'active' : ''}}"
            bindtap="setSortType"
            data-type="createdAt"
            data-order="desc">
            <text>创建时间（最新）</text>
            <text class="iconfont icon-check" wx:if="{{sortType === 'createdAt' && sortOrder === 'desc'}}"></text>
          </view>
          <view 
            class="sort-item {{sortType === 'createdAt' && sortOrder === 'asc' ? 'active' : ''}}"
            bindtap="setSortType"
            data-type="createdAt"
            data-order="asc">
            <text>创建时间（最早）</text>
            <text class="iconfont icon-check" wx:if="{{sortType === 'createdAt' && sortOrder === 'asc'}}"></text>
          </view>
          <view 
            class="sort-item {{sortType === 'completionRate' && sortOrder === 'desc' ? 'active' : ''}}"
            bindtap="setSortType"
            data-type="completionRate"
            data-order="desc">
            <text>完成率（高到低）</text>
            <text class="iconfont icon-check" wx:if="{{sortType === 'completionRate' && sortOrder === 'desc'}}"></text>
          </view>
          <view 
            class="sort-item {{sortType === 'completionRate' && sortOrder === 'asc' ? 'active' : ''}}"
            bindtap="setSortType"
            data-type="completionRate"
            data-order="asc">
            <text>完成率（低到高）</text>
            <text class="iconfont icon-check" wx:if="{{sortType === 'completionRate' && sortOrder === 'asc'}}"></text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
